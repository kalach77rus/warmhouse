@startuml
!include <C4/C4_Container>

AddElementTag("microservice", $bgColor="#87ceeb", $fontColor="#000000")
AddElementTag("db", $bgColor="#ff9f28", $fontColor="#ffffff")
AddElementTag("queue", $bgColor="#5b9bd5", $fontColor="#ffffff")
AddElementTag("cache", $bgColor="#ff6b6b", $fontColor="#ffffff")
AddElementTag("storage", $bgColor="#9b59b6", $fontColor="#ffffff")

Person(user, "Пользователь", "Владелец умного дома")

System_Boundary(warmhouse, "Система WarmHouse") {
    Container(authproxy, "Auth Proxy", "warmhouse-authproxy", "Аутентификация и проксирование запросов", $tags="microservice")
    Container(user_api, "User API", "warmhouse-user-api", "Обработка пользовательских запросов", $tags="microservice")
    Container(devices, "Devices Service", "warmhouse-devices", "Управление всеми устройствами (ворота, датчики)", $tags="microservice")
    
    ContainerDb(db, "Database", "PostgreSQL", "Главное хранилище данных", $tags="db")
    ContainerQueue(queue, "Message Queue", "RabbitMQ", "Шина событий", $tags="queue")
    ContainerDb(redis, "Redis Cache", "Redis", "Кэш сессий и аутентификации", $tags="cache")
}

Rel(user, authproxy, "Отправляет запросы", "HTTPS")
Rel(authproxy, user_api, "Проксирует запросы", "HTTP")
Rel(authproxy, redis, "Кэширует сессии", "Redis Protocol")

Rel(user_api, db, "Чтение данных", "JDBC\n(read-only)")
Rel(devices, db, "Чтение/запись", "JDBC")

Rel(user_api, queue, "Публикация команд", "AMQP")
Rel(queue, devices, "Слушает команды", "AMQP")


System_Ext(sensors, "Датчики температуры", "Внешние устройства")
System_Ext(gates_hw, "Ворота", "Автоматические ворота гаража")

Rel(devices, sensors, "Получение телеметрии", "HTTP/REST")
Rel(devices, gates_hw, "Управление двигателем", "HTTP/REST")

@enduml