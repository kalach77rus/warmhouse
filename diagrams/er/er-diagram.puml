@startuml Device Service ER Diagram

!define RECTANGLE class

skinparam class {
    BackgroundColor<<Entity>> LightBlue
    BackgroundColor<<External>> LightYellow
    BackgroundColor<<Index>> LightGreen
    BackgroundColor<<TimeSeries>> LightCyan
    BackgroundColor<<Event>> LightPink
    BorderColor Black
    ArrowColor Black
}

title ER-диаграмма системы умного дома (расширенная версия)

' Основные сущности
RECTANGLE "Devices" as devices <<Entity>> {
    +id: SERIAL PRIMARY KEY
    +name: VARCHAR(100) NOT NULL
    +type: VARCHAR(50) NOT NULL
    +location: VARCHAR(100) NOT NULL
    +status: VARCHAR(20) NOT NULL DEFAULT 'inactive'
    +config_id: INTEGER
    +created_at: TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    +updated_at: TIMESTAMP WITH TIME ZONE DEFAULT NOW()
}

RECTANGLE "Sensors" as sensors <<Entity>> {
    +id: SERIAL PRIMARY KEY
    +name: VARCHAR(100) NOT NULL
    +type: VARCHAR(50) NOT NULL
    +location: VARCHAR(100) NOT NULL
    +value: FLOAT DEFAULT 0
    +unit: VARCHAR(20)
    +status: VARCHAR(20) NOT NULL DEFAULT 'inactive'
    +last_updated: TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
    +created_at: TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
}

RECTANGLE "Device Configs" as device_configs <<Entity>> {
    +id: SERIAL PRIMARY KEY
    +device_id: INTEGER NOT NULL
    +config_type: VARCHAR(50) NOT NULL
    +config_data: JSONB NOT NULL
    +version: INTEGER DEFAULT 1
    +is_active: BOOLEAN DEFAULT true
    +created_at: TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    +updated_at: TIMESTAMP WITH TIME ZONE DEFAULT NOW()
}

' События устройств
RECTANGLE "Device Events" as device_events <<Event>> {
    +id: UUID PRIMARY KEY
    +device_id: INTEGER NOT NULL
    +event_type: VARCHAR(50) NOT NULL
    +event_data: JSONB
    +severity: VARCHAR(20) NOT NULL
    +timestamp: TIMESTAMP WITH TIME ZONE NOT NULL
    +processed: BOOLEAN DEFAULT false
    +processed_at: TIMESTAMP WITH TIME ZONE
    +created_at: TIMESTAMP WITH TIME ZONE DEFAULT NOW()
}

RECTANGLE "Alerts" as alerts <<Entity>> {
    +id: SERIAL PRIMARY KEY
    +device_id: INTEGER
    +sensor_id: INTEGER
    +type: VARCHAR(50) NOT NULL
    +severity: VARCHAR(20) NOT NULL
    +message: TEXT NOT NULL
    +threshold_value: FLOAT
    +current_value: FLOAT
    +status: VARCHAR(20) DEFAULT 'active'
    +created_at: TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    +resolved_at: TIMESTAMP WITH TIME ZONE
    +acknowledged_at: TIMESTAMP WITH TIME ZONE
}

' Дополнительные сущности
RECTANGLE "Locations" as locations <<Entity>> {
    +id: SERIAL PRIMARY KEY
    +name: VARCHAR(100) NOT NULL
    +description: TEXT
    +floor: INTEGER
    +room_type: VARCHAR(50)
    +created_at: TIMESTAMP WITH TIME ZONE DEFAULT NOW()
}

RECTANGLE "Device Types" as device_types <<Entity>> {
    +id: SERIAL PRIMARY KEY
    +name: VARCHAR(50) NOT NULL
    +description: TEXT
    +capabilities: JSONB
    +supported_configs: JSONB
    +created_at: TIMESTAMP WITH TIME ZONE DEFAULT NOW()
}

' Индексы
RECTANGLE "Indexes" as indexes <<Index>> {
    +idx_devices_type: ON devices(type)
    +idx_devices_location: ON devices(location)
    +idx_devices_status: ON devices(status)
    +idx_sensors_type: ON sensors(type)
    +idx_sensors_location: ON sensors(location)
    +idx_sensors_status: ON sensors(status)
    +idx_device_configs_device_id: ON device_configs(device_id)
    +idx_device_configs_active: ON device_configs(is_active)
    +idx_device_events_device_id: ON device_events(device_id)
    +idx_device_events_type: ON device_events(event_type)
    +idx_device_events_timestamp: ON device_events(timestamp)
    +idx_alerts_device_id: ON alerts(device_id)
    +idx_alerts_sensor_id: ON alerts(sensor_id)
    +idx_alerts_status: ON alerts(status)
}

' Связи между сущностями
devices ||--o{ device_configs : "has many"
devices }o--|| locations : "belongs to"
devices }o--|| device_types : "belongs to"
devices ||--o{ device_events : "generates"
devices ||--o{ alerts : "triggers"
sensors ||--o{ alerts : "triggers"

' Ограничения
note right of devices
  Constraints:
  - name NOT NULL
  - type NOT NULL
  - location NOT NULL
  - status IN ('active', 'inactive', 'error', 'maintenance')
  - config_id FOREIGN KEY REFERENCES device_configs(id)
end note

note right of device_configs
  Constraints:
  - device_id FOREIGN KEY REFERENCES devices(id)
  - config_type NOT NULL
  - config_data JSONB format
  - version >= 1
  - Only one active config per device
end note

note right of device_events
  Constraints:
  - device_id FOREIGN KEY REFERENCES devices(id)
  - event_type IN ('status_change', 'error', 'config_update', 'alert')
  - severity IN ('low', 'medium', 'high', 'critical')
  - timestamp NOT NULL
end note

note right of alerts
  Constraints:
  - device_id OR sensor_id must be present
  - severity IN ('low', 'medium', 'high', 'critical')
  - status IN ('active', 'resolved', 'acknowledged')
  - threshold_value validation
end note

@enduml 