name: PlantUML Diagrams

on:
  push:
    branches:
      - warmhouse
  pull_request:
    branches:
      - warmhouse

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è

      - name: Set up Java
        uses: actions/setup-java@v4  # –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è
        with:
          java-version: '17'  # Java 11 —É—Å—Ç–∞—Ä–µ–ª–∞
          distribution: 'temurin'

      - name: Install PlantUML
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é PlantUML
          wget https://github.com/plantuml/plantuml/releases/latest/download/plantuml-1.2024.6.jar -O plantuml.jar
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å apt:
          # sudo apt-get update && sudo apt-get install -y plantuml

      - name: Check if diagram directories exist
        run: |
          echo "Checking diagram directories..."
          ls -la diagrams/ || echo "diagrams directory not found"
          find diagrams/ -name "*.puml" -type f || echo "No .puml files found"

      - name: Generate Diagrams
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          mkdir -p diagrams/context diagrams/container
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∏–∞–≥—Ä–∞–º–º—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º jar —Ñ–∞–π–ª–∞
          if [ -f plantuml.jar ]; then
            find diagrams/ -name "*.puml" -exec java -jar plantuml.jar {} \;
          else
            # Fallback –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π plantuml
            find diagrams/ -name "*.puml" -exec plantuml {} \;
          fi
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          echo "Generated files:"
          find diagrams/ -name "*.png" -o -name "*.svg"

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Diagrams
        if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          git add diagrams/**/*.png diagrams/**/*.svg
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —á—Ç–æ –∫–æ–º–º–∏—Ç–∏—Ç—å
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "ü§ñ Automated diagram generation [skip ci]"
          git push origin main

      - name: Upload artifacts (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-diagrams
          path: diagrams/**/*.png
          retention-days: 5